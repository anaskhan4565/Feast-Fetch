@page
@model FeastFetch.Pages.Admin.DashboardModel
@{
    ViewData["Title"] = "Admin Dashboard";
}

<div class="page-header text-white text-center">
    <div class="container">
        <h1 class="display-3 fw-bold"><i class="bi bi-speedometer2 me-3"></i>Admin Dashboard</h1>
        <p class="lead">Manage menu items and orders</p>
    </div>
</div>

<div class="container py-5">
    <!-- Quick Stats -->
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card shadow-lg border-0 text-center">
                <div class="card-body p-4">
                    <div class="mb-3">
                        <i class="bi bi-card-list" style="font-size: 3rem; color: var(--primary);"></i>
                    </div>
                    <h3 class="fw-bold" id="totalMenuItems">0</h3>
                    <p class="text-muted mb-0">Menu Items</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-lg border-0 text-center">
                <div class="card-body p-4">
                    <div class="mb-3">
                        <i class="bi bi-box-seam" style="font-size: 3rem; color: var(--primary);"></i>
                    </div>
                    <h3 class="fw-bold" id="totalOrders">0</h3>
                    <p class="text-muted mb-0">Total Orders</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-lg border-0 text-center">
                <div class="card-body p-4">
                    <div class="mb-3">
                        <i class="bi bi-clock-history" style="font-size: 3rem; color: var(--primary);"></i>
                    </div>
                    <h3 class="fw-bold" id="pendingOrders">0</h3>
                    <p class="text-muted mb-0">Pending Orders</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Menu Item Section -->
    <div class="card shadow-lg border-0 mb-5">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Add New Menu Item</h4>
        </div>
        <div class="card-body p-4">
            <form id="addMenuItemForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="itemName" class="form-label fw-semibold">Item Name *</label>
                        <input type="text" class="form-control" id="itemName" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="itemCategory" class="form-label fw-semibold">Category *</label>
                        <select class="form-select" id="itemCategory" required>
                            <option value="">Select Category</option>
                            <option value="Burgers">Burgers</option>
                            <option value="Pizza">Pizza</option>
                            <option value="Cake">Cake</option>
                            <option value="Shakes">Shakes</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="itemDescription" class="form-label fw-semibold">Description *</label>
                    <textarea class="form-control" id="itemDescription" rows="3" required></textarea>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="itemPrice" class="form-label fw-semibold">Price *</label>
                        <input type="number" class="form-control" id="itemPrice" step="0.01" min="0" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="itemAvailable" class="form-label fw-semibold">Availability *</label>
                        <select class="form-select" id="itemAvailable" required>
                            <option value="true">Available</option>
                            <option value="false">Not Available</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="itemImage" class="form-label fw-semibold">Item Image</label>
                    <input type="file" class="form-control" id="itemImage" accept="image/*">
                    <small class="text-muted">Select an image file (JPG, PNG, etc.)</small>
                    <div id="imagePreview" class="mt-3" style="display: none;">
                        <img id="previewImg" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                    </div>
                </div>
                <div class="alert alert-danger" id="errorMessage" style="display: none;"></div>
                <div class="alert alert-success" id="successMessage" style="display: none;"></div>
                <button type="submit" class="btn btn-primary btn-lg" id="submitButton">
                    <i class="bi bi-check-circle me-2"></i>Add Menu Item
                </button>
            </form>
        </div>
    </div>

    <!-- Menu Items List -->
    <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="bi bi-card-list me-2"></i>Menu Items</h4>
            <button class="btn btn-light btn-sm" onclick="loadMenuItems()">
                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
            </button>
        </div>
        <div class="card-body p-4">
            <div id="menuItemsList" class="row g-4">
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading menu items...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Menu Item Modal -->
<div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editItemModalLabel">
                    <i class="bi bi-pencil me-2"></i>Edit Menu Item
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editMenuItemForm">
                    <input type="hidden" id="editItemId">
                    <div class="mb-3">
                        <label for="editItemName" class="form-label fw-semibold">Item Name *</label>
                        <input type="text" class="form-control" id="editItemName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editItemDescription" class="form-label fw-semibold">Description</label>
                        <textarea class="form-control" id="editItemDescription" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editItemCategory" class="form-label fw-semibold">Category *</label>
                            <select class="form-select" id="editItemCategory" required>
                                <option value="">Select category...</option>
                                <option value="appetizers">Appetizers</option>
                                <option value="main-courses">Main Courses</option>
                                <option value="desserts">Desserts</option>
                                <option value="beverages">Beverages</option>
                                <option value="salads">Salads</option>
                                <option value="soups">Soups</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editItemPrice" class="form-label fw-semibold">Price *</label>
                            <input type="number" class="form-control" id="editItemPrice" step="0.01" min="0" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editItemAvailable" class="form-label fw-semibold">Availability *</label>
                            <select class="form-select" id="editItemAvailable" required>
                                <option value="true">Available</option>
                                <option value="false">Not Available</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editItemImage" class="form-label fw-semibold">Item Image</label>
                        <input type="file" class="form-control" id="editItemImage" accept="image/*">
                        <small class="text-muted">Leave empty to keep current image, or select a new image</small>
                        <div id="editImagePreview" class="mt-3" style="display: none;">
                            <img id="editPreviewImg" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                        </div>
                    </div>
                    <div class="alert alert-danger" id="editErrorMessage" style="display: none;"></div>
                    <div class="alert alert-success" id="editSuccessMessage" style="display: none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateMenuItemButton">
                    <i class="bi bi-check-circle me-2"></i>Update Menu Item
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // IMPORTANT: All admin API calls must use AdminUtils.adminApiCall()
        // This automatically includes the X-Admin-Key header with the secret token
        // Example: await AdminUtils.adminApiCall(url, { method: 'POST', body: formData });
        
        // Check if admin is logged in
        if (!AdminUtils || !AdminUtils.isAdmin()) {
            window.location.href = '/Login';
        }
        
        // Store modal instance to prevent multiple instances
        let editItemModalInstance = null;
        
        // Helper function to clean up modal backdrop
        function cleanupModalBackdrop() {
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }
        
        // Add event listener to clean up backdrop when modal is hidden
        document.addEventListener('DOMContentLoaded', function() {
            const editModal = document.getElementById('editItemModal');
            if (editModal) {
                editModal.addEventListener('hidden.bs.modal', cleanupModalBackdrop);
            }
        });

        // Image preview
        document.getElementById('itemImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('imagePreview').style.display = 'none';
            }
        });

        // Load menu items on page load
        loadMenuItems();

        // Handle form submission
        document.getElementById('addMenuItemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            const submitButton = document.getElementById('submitButton');
            const originalButtonText = submitButton.innerHTML;
            
            // Hide previous messages
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            
            // Get form data
            const name = document.getElementById('itemName').value;
            const description = document.getElementById('itemDescription').value;
            const price = document.getElementById('itemPrice').value;
            const category = document.getElementById('itemCategory').value;
            const available = document.getElementById('itemAvailable').value;
            const imageFile = document.getElementById('itemImage').files[0];
            
            // Validate
            if (!name || !description || !price || !category) {
                errorMessage.textContent = 'Please fill in all required fields.';
                errorMessage.style.display = 'block';
                return;
            }
            
            // Disable button and show loading
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Adding...';
            
            try {
                // Create FormData
                const formData = new FormData();
                formData.append('name', name);
                formData.append('description', description);
                formData.append('price', price);
                formData.append('category', category);
                formData.append('available', available);
                
                if (imageFile) {
                    formData.append('imageBuffer', imageFile);
                    console.log('Image file details:', {
                        name: imageFile.name,
                        size: imageFile.size,
                        type: imageFile.type
                    });
                }
                
                console.log('Sending menu item to API...');
                console.log('FormData entries:', {
                    name, description, price, category, available,
                    hasImage: !!imageFile
                });
                
                // Log FormData contents (for debugging)
                console.log('FormData contents:');
                for (let pair of formData.entries()) {
                    if (pair[1] instanceof File) {
                        console.log(`  ${pair[0]}: [File] ${pair[1].name} (${pair[1].size} bytes, ${pair[1].type})`);
                    } else {
                        console.log(`  ${pair[0]}: ${pair[1]}`);
                    }
                }
                
                // Call API using AdminUtils (automatically includes secret key header)
                const response = await AdminUtils.adminApiCall(
                    'https://feastfetchfunctionappk224626-fjfadrgzcgfwcqev.centralindia-01.azurewebsites.net/api/admin/menu',
                    {
                        method: 'POST',
                        body: formData
                    }
                );
                
                console.log('Response status:', response.status);
                console.log('Response statusText:', response.statusText);
                console.log('Response headers:', response.headers);
                
                const responseText = await response.text();
                console.log('Response body (raw):', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('Response body (parsed):', data);
                } catch (e) {
                    console.error('Failed to parse response as JSON:', e);
                    console.error('Response text:', responseText);
                    // If response is not JSON, treat as error
                    throw new Error(responseText || `Server returned ${response.status} ${response.statusText}`);
                }
                
                // Check if request was successful (200-299 status codes)
                if (response.ok) {
                    // If response explicitly says success=false, treat as error
                    if (data.success === false) {
                        console.error('API returned success=false:', data);
                        throw new Error(data.message || data.error || 'Failed to add menu item');
                    }
                    
                    // Success - show message and reset form
                    successMessage.textContent = data.message || 'Menu item added successfully!';
                    successMessage.style.display = 'block';
                    
                    // Reset form
                    document.getElementById('addMenuItemForm').reset();
                    document.getElementById('imagePreview').style.display = 'none';
                    
                    // Reload menu items
                    loadMenuItems();
                    
                    // Hide success message after 3 seconds
                    setTimeout(() => {
                        successMessage.style.display = 'none';
                    }, 3000);
                } else {
                    // Non-2xx status code - definitely an error
                    console.error('API returned error:', {
                        status: response.status,
                        statusText: response.statusText,
                        data: data
                    });
                    throw new Error(data.message || data.error || `Server returned ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error adding menu item:', error);
                errorMessage.textContent = error.message || 'An error occurred. Please try again.';
                errorMessage.style.display = 'block';
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        });
        
        // Load menu items from API
        async function loadMenuItems() {
            try {
                const response = await fetch('https://feastfetchfunctionappk224626-fjfadrgzcgfwcqev.centralindia-01.azurewebsites.net/api/menu');
                console.log('Response status:', response);
                if (!response.ok) {
                    throw new Error('Failed to load menu items');
                }
                
                const data = await response.json();
                const categories = data.categories || [];
                
                // Store menu items for edit function
                currentMenuItems = categories;
                
                // Count total items
                let totalItems = 0;
                categories.forEach(cat => {
                    totalItems += cat.items ? cat.items.length : 0;
                });
                document.getElementById('totalMenuItems').textContent = totalItems;
                
                // Render menu items
                const container = document.getElementById('menuItemsList');
                if (totalItems === 0) {
                    container.innerHTML = `
                        <div class="col-12 text-center py-5">
                            <i class="bi bi-card-list" style="font-size: 4rem; color: var(--gray-light);"></i>
                            <h4 class="mt-3 text-muted">No menu items yet</h4>
                            <p class="text-muted">Add your first menu item above</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = categories.map(category => {
                    if (!category.items || category.items.length === 0) return '';
                    
                    return category.items.map(item => `
                        <div class="col-md-6 col-lg-4">
                            <div class="card shadow-sm border-0 h-100">
                                <div class="card-img-top" style="height: 200px; background: ${item.imageUrl ? `url('${item.imageUrl}')` : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}; background-size: cover; background-position: center; position: relative;">
                                    ${!item.imageUrl ? '<i class="bi bi-image" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; color: white; opacity: 0.5;"></i>' : ''}
                                </div>
                                <div class="card-body">
                                    <h5 class="card-title">${item.name}</h5>
                                    <p class="card-text text-muted small">${item.description || ''}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-primary">${category.name}</span>
                                        <span class="fw-bold text-primary">$${parseFloat(item.price).toFixed(2)}</span>
                                    </div>
                                    <div class="mt-3 d-flex gap-2">
                                        <button class="btn btn-sm btn-outline-primary flex-fill" onclick="editMenuItem('${item.id}')">
                                            <i class="bi bi-pencil me-1"></i>Edit
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger flex-fill" onclick="deleteMenuItem('${item.id}')">
                                            <i class="bi bi-trash me-1"></i>Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }).filter(html => html).join('');
                
            } catch (error) {
                console.error('Error loading menu items:', error);
                document.getElementById('menuItemsList').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Failed to load menu items. Please try again.
                        </div>
                    </div>
                `;
            }
        }
        
        // Store current menu items for edit modal
        let currentMenuItems = [];
        
        // Edit menu item - opens modal with item data
        async function editMenuItem(itemId) {
            console.log('Edit menu item:', itemId);
            
            // Find the item in the current menu items
            let item = null;
            let itemCategory = '';
            for (const category of currentMenuItems) {
                if (category.items) {
                    item = category.items.find(i => i.id === itemId);
                    if (item) {
                        // Try to get category from item first, then from parent category
                        itemCategory = item.category || category.name || '';
                        break;
                    }
                }
            }
            
            if (!item) {
                alert('Menu item not found. Please refresh the page.');
                return;
            }
            
            // Populate edit form
            document.getElementById('editItemId').value = item.id;
            document.getElementById('editItemName').value = item.name || '';
            document.getElementById('editItemDescription').value = item.description || '';
            
            // Set category - try item.category first, then derive from parent category name
            const categorySelect = document.getElementById('editItemCategory');
            if (item.category) {
                categorySelect.value = item.category;
            } else if (itemCategory) {
                // Try to match category name to dropdown value
                const categoryMap = {
                    'appetizers': 'appetizers',
                    'main courses': 'main-courses',
                    'main-courses': 'main-courses',
                    'desserts': 'desserts',
                    'beverages': 'beverages',
                    'salads': 'salads',
                    'soups': 'soups'
                };
                const normalizedCategory = itemCategory.toLowerCase().trim();
                categorySelect.value = categoryMap[normalizedCategory] || '';
            }
            
            document.getElementById('editItemPrice').value = item.price || '';
            document.getElementById('editItemAvailable').value = item.available !== false ? 'true' : 'false';
            
            // Show current image if available
            if (item.imageUrl) {
                document.getElementById('editPreviewImg').src = item.imageUrl;
                document.getElementById('editImagePreview').style.display = 'block';
            } else {
                document.getElementById('editImagePreview').style.display = 'none';
            }
            
            // Hide messages
            document.getElementById('editErrorMessage').style.display = 'none';
            document.getElementById('editSuccessMessage').style.display = 'none';
            
            // Show modal - use single instance to prevent backdrop issues
            const modalEl = document.getElementById('editItemModal');
            if (!editItemModalInstance) {
                editItemModalInstance = new bootstrap.Modal(modalEl);
            }
            editItemModalInstance.show();
        }
        
        // Handle edit form image preview
        document.getElementById('editItemImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('editPreviewImg').src = e.target.result;
                    document.getElementById('editImagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Handle update menu item
        document.getElementById('updateMenuItemButton').addEventListener('click', async function() {
            const form = document.getElementById('editMenuItemForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const itemId = document.getElementById('editItemId').value;
            const name = document.getElementById('editItemName').value.trim();
            const description = document.getElementById('editItemDescription').value.trim();
            const category = document.getElementById('editItemCategory').value;
            const price = parseFloat(document.getElementById('editItemPrice').value);
            const available = document.getElementById('editItemAvailable').value === 'true';
            const imageFile = document.getElementById('editItemImage').files[0];
            
            const errorMessage = document.getElementById('editErrorMessage');
            const successMessage = document.getElementById('editSuccessMessage');
            const submitButton = document.getElementById('updateMenuItemButton');
            const originalButtonText = submitButton.innerHTML;
            
            // Hide previous messages
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            
            // Disable button
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
            
            try {
                const apiUrl = `https://feastfetchfunctionappk224626-fjfadrgzcgfwcqev.centralindia-01.azurewebsites.net/api/admin/menu/${itemId}`;

                // Always send JSON directly (do not use FormData, do not send images)
                const body = JSON.stringify({
                    name: name,
                    description: description,
                    price: price,
                    category: category,
                    available: available
                });

                // Get secret key directly for authentication
                let secretKey = localStorage.getItem('adminSecretKey');
                if (!secretKey) {
                    const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
                    if (currentUser && currentUser.secretKey) {
                        secretKey = currentUser.secretKey;
                        localStorage.setItem('adminSecretKey', secretKey);
                    }
                }
                if (!secretKey) throw new Error('Admin secret key not found. Please login again.');

                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: body
                });

                const responseText = await response.text();
                console.log('Update response:', responseText);

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error('Failed to parse response as JSON:', e);
                    throw new Error(responseText || `Server returned ${response.status} ${response.statusText}`);
                }
                if (response.ok) {
                    if (data.success === false) {
                        throw new Error(data.message || 'Failed to update menu item');
                    }
                    
                    successMessage.textContent = data.message || 'Menu item updated successfully!';
                    successMessage.style.display = 'block';
                    
                    // Reload menu items
                    loadMenuItems();
                    
                    // Close modal after 1.5 seconds
                    setTimeout(() => {
                        if (editItemModalInstance) {
                            editItemModalInstance.hide();
                        }
                        successMessage.style.display = 'none';
                        // Clean up any stuck backdrops
                        setTimeout(cleanupModalBackdrop, 300);
                    }, 1500);
                } else {
                    throw new Error(data.message || `Server returned ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error updating menu item:', error);
                errorMessage.textContent = error.message || 'An error occurred. Please try again.';
                errorMessage.style.display = 'block';
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        });
        
        // Delete menu item
        async function deleteMenuItem(itemId) {
            if (!confirm('Are you sure you want to delete this menu item? This action cannot be undone.')) {
                return;
            }
            
            try {
                console.log('Deleting menu item:', itemId);
                
                const apiUrl = `https://feastfetchfunctionappk224626-fjfadrgzcgfwcqev.centralindia-01.azurewebsites.net/api/admin/menu/${itemId}`;
                
                const response = await AdminUtils.adminApiCall(apiUrl, {
                    method: 'DELETE'
                });
                
                const responseText = await response.text();
                console.log('Delete response:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    // If response is not JSON, check if status is OK
                    if (response.ok) {
                        // Success even without JSON response
                        loadMenuItems();
                        alert('Menu item deleted successfully!');
                        return;
                    }
                    throw new Error(responseText || `Server returned ${response.status} ${response.statusText}`);
                }
                
                if (response.ok) {
                    if (data.success === false) {
                        throw new Error(data.message || 'Failed to delete menu item');
                    }
                    
                    // Reload menu items
                    loadMenuItems();
                    alert(data.message || 'Menu item deleted successfully!');
                } else {
                    throw new Error(data.message || `Server returned ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error deleting menu item:', error);
                alert('Failed to delete menu item: ' + (error.message || 'Please try again.'));
            }
        }
    </script>
}

