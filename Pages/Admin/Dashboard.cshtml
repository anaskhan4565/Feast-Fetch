@page
@model FeastFetch.Pages.Admin.DashboardModel
@{
    ViewData["Title"] = "Admin Dashboard";
}

<div class="page-header text-white text-center">
    <div class="container">
        <h1 class="display-3 fw-bold"><i class="bi bi-speedometer2 me-3"></i>Admin Dashboard</h1>
        <p class="lead">Manage menu items and orders</p>
    </div>
</div>

<div class="container py-5">
    <!-- Quick Stats -->
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card shadow-lg border-0 text-center">
                <div class="card-body p-4">
                    <div class="mb-3">
                        <i class="bi bi-card-list" style="font-size: 3rem; color: var(--primary);"></i>
                    </div>
                    <h3 class="fw-bold" id="totalMenuItems">0</h3>
                    <p class="text-muted mb-0">Menu Items</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-lg border-0 text-center">
                <div class="card-body p-4">
                    <div class="mb-3">
                        <i class="bi bi-box-seam" style="font-size: 3rem; color: var(--primary);"></i>
                    </div>
                    <h3 class="fw-bold" id="totalOrders">0</h3>
                    <p class="text-muted mb-0">Total Orders</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-lg border-0 text-center">
                <div class="card-body p-4">
                    <div class="mb-3">
                        <i class="bi bi-clock-history" style="font-size: 3rem; color: var(--primary);"></i>
                    </div>
                    <h3 class="fw-bold" id="pendingOrders">0</h3>
                    <p class="text-muted mb-0">Pending Orders</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Menu Item Section -->
    <div class="card shadow-lg border-0 mb-5">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Add New Menu Item</h4>
        </div>
        <div class="card-body p-4">
            <form id="addMenuItemForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="itemName" class="form-label fw-semibold">Item Name *</label>
                        <input type="text" class="form-control" id="itemName" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="itemCategory" class="form-label fw-semibold">Category *</label>
                        <select class="form-select" id="itemCategory" required>
                            <option value="">Select Category</option>
                            <option value="Burgers">Burgers</option>
                            <option value="Pizza">Pizza</option>
                            <option value="Cake">Cake</option>
                            <option value="Shakes">Shakes</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="itemDescription" class="form-label fw-semibold">Description *</label>
                    <textarea class="form-control" id="itemDescription" rows="3" required></textarea>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="itemPrice" class="form-label fw-semibold">Price *</label>
                        <input type="number" class="form-control" id="itemPrice" step="0.01" min="0" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="itemAvailable" class="form-label fw-semibold">Availability *</label>
                        <select class="form-select" id="itemAvailable" required>
                            <option value="true">Available</option>
                            <option value="false">Not Available</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="itemImage" class="form-label fw-semibold">Item Image</label>
                    <input type="file" class="form-control" id="itemImage" accept="image/*">
                    <small class="text-muted">Select an image file (JPG, PNG, etc.)</small>
                    <div id="imagePreview" class="mt-3" style="display: none;">
                        <img id="previewImg" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                    </div>
                </div>
                <div class="alert alert-danger" id="errorMessage" style="display: none;"></div>
                <div class="alert alert-success" id="successMessage" style="display: none;"></div>
                <button type="submit" class="btn btn-primary btn-lg" id="submitButton">
                    <i class="bi bi-check-circle me-2"></i>Add Menu Item
                </button>
            </form>
        </div>
    </div>

    <!-- Menu Items List -->
    <div class="card shadow-lg border-0 mb-5">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="bi bi-card-list me-2"></i>Menu Items</h4>
            <button class="btn btn-light btn-sm" onclick="loadMenuItems()">
                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
            </button>
        </div>
        <div class="card-body p-4">
            <div id="menuItemsList" class="row g-4">
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading menu items...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders List -->
    <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="bi bi-box-seam me-2"></i>All Orders</h4>
            <button class="btn btn-light btn-sm" onclick="loadOrders()">
                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
            </button>
        </div>
        <div class="card-body p-4">
            <div id="ordersList" class="row g-4">
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading orders...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Menu Item Dialog - Inline Style -->
<div id="editItemDialog" class="position-fixed top-0 start-0 w-100 h-100" style="display: none; z-index: 9999; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); overflow-y: auto;">
    <div class="d-flex align-items-start justify-content-center py-4" style="min-height: 100%;">
        <div class="card shadow-lg border-0 my-4" style="max-width: 600px; width: 95%; border-radius: 16px; overflow: hidden;">
            <div class="card-header bg-primary text-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-pencil me-2"></i>Edit Menu Item</h5>
                <button type="button" class="btn-close btn-close-white" id="closeEditDialog" aria-label="Close"></button>
            </div>
            <div class="card-body p-4">
                <form id="editMenuItemForm">
                    <input type="hidden" id="editItemId">
                    <div class="mb-3">
                        <label for="editItemName" class="form-label fw-semibold">Item Name *</label>
                        <input type="text" class="form-control" id="editItemName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editItemDescription" class="form-label fw-semibold">Description</label>
                        <textarea class="form-control" id="editItemDescription" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editItemCategory" class="form-label fw-semibold">Category *</label>
                            <select class="form-select" id="editItemCategory" required>
                                <option value="">Select category...</option>
                                <option value="appetizers">Appetizers</option>
                                <option value="main-courses">Main Courses</option>
                                <option value="desserts">Desserts</option>
                                <option value="beverages">Beverages</option>
                                <option value="salads">Salads</option>
                                <option value="soups">Soups</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editItemPrice" class="form-label fw-semibold">Price *</label>
                            <input type="number" class="form-control" id="editItemPrice" step="0.01" min="0" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editItemAvailable" class="form-label fw-semibold">Availability *</label>
                            <select class="form-select" id="editItemAvailable" required>
                                <option value="true">Available</option>
                                <option value="false">Not Available</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editItemImage" class="form-label fw-semibold">Item Image</label>
                        <input type="file" class="form-control" id="editItemImage" accept="image/*">
                        <small class="text-muted">Leave empty to keep current image, or select a new image</small>
                        <div id="editImagePreview" class="mt-3" style="display: none;">
                            <img id="editPreviewImg" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                        </div>
                    </div>
                    <div class="alert alert-danger" id="editErrorMessage" style="display: none;"></div>
                    <div class="alert alert-success" id="editSuccessMessage" style="display: none;"></div>
                </form>
            </div>
            <div class="card-footer bg-white border-0 d-flex gap-2 justify-content-end p-3">
                <button type="button" class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateMenuItemButton">
                    <i class="bi bi-check-circle me-2"></i>Update Menu Item
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // IMPORTANT: All admin API calls must use AdminUtils.adminApiCall()
        // This automatically includes the X-Admin-Key header with the secret token
        // Example: await AdminUtils.adminApiCall(url, { method: 'POST', body: formData });
        
        // Check if admin is logged in
        if (!AdminUtils || !AdminUtils.isAdmin()) {
            window.location.href = '/Login';
        }
        
        // Show/hide the edit dialog
        function showEditDialog(show) {
            const dialog = document.getElementById('editItemDialog');
            if (show) {
                dialog.style.display = 'block';
                document.body.style.overflow = 'hidden';
            } else {
                dialog.style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        // Set up dialog close handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Close button handler
            document.getElementById('closeEditDialog').addEventListener('click', function() {
                showEditDialog(false);
            });
            
            // Cancel button handler
            document.getElementById('cancelEditBtn').addEventListener('click', function() {
                showEditDialog(false);
            });
            
            // Close on backdrop click
            document.getElementById('editItemDialog').addEventListener('click', function(e) {
                if (e.target === this) {
                    showEditDialog(false);
                }
            });
            
            // Close on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.getElementById('editItemDialog').style.display === 'block') {
                    showEditDialog(false);
                }
            });
        });

        // Image preview
        document.getElementById('itemImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('imagePreview').style.display = 'none';
            }
        });

        // Store menu items map for order display
        let menuItemsMap = {};
        
        // Load menu items on page load
        loadMenuItems();
        
        // Load orders on page load
        loadOrders();

        // Handle form submission
        document.getElementById('addMenuItemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            const submitButton = document.getElementById('submitButton');
            const originalButtonText = submitButton.innerHTML;
            
            // Hide previous messages
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            
            // Get form data
            const name = document.getElementById('itemName').value;
            const description = document.getElementById('itemDescription').value;
            const price = document.getElementById('itemPrice').value;
            const category = document.getElementById('itemCategory').value;
            const available = document.getElementById('itemAvailable').value;
            const imageFile = document.getElementById('itemImage').files[0];
            
            // Validate
            if (!name || !description || !price || !category) {
                errorMessage.textContent = 'Please fill in all required fields.';
                errorMessage.style.display = 'block';
                return;
            }
            
            // Disable button and show loading
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Adding...';
            
            try {
                // Create FormData
                const formData = new FormData();
                formData.append('name', name);
                formData.append('description', description);
                formData.append('price', price);
                formData.append('category', category);
                formData.append('available', available);
                
                if (imageFile) {
                    formData.append('imageBuffer', imageFile);
                    console.log('Image file details:', {
                        name: imageFile.name,
                        size: imageFile.size,
                        type: imageFile.type
                    });
                }
                
                console.log('Sending menu item to API...');
                console.log('FormData entries:', {
                    name, description, price, category, available,
                    hasImage: !!imageFile
                });
                
                // Log FormData contents (for debugging)
                console.log('FormData contents:');
                for (let pair of formData.entries()) {
                    if (pair[1] instanceof File) {
                        console.log(`  ${pair[0]}: [File] ${pair[1].name} (${pair[1].size} bytes, ${pair[1].type})`);
                    } else {
                        console.log(`  ${pair[0]}: ${pair[1]}`);
                    }
                }
                
                // Call API using AdminUtils (automatically includes secret key header)
                const response = await AdminUtils.adminApiCall(
                    'https://feastfetchfunctionappk224626-fjfadrgzcgfwcqev.centralindia-01.azurewebsites.net/api/admin/menu',
                    {
                        method: 'POST',
                        body: formData
                    }
                );
                
                console.log('Response status:', response.status);
                console.log('Response statusText:', response.statusText);
                console.log('Response headers:', response.headers);
                
                const responseText = await response.text();
                console.log('Response body (raw):', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('Response body (parsed):', data);
                } catch (e) {
                    console.error('Failed to parse response as JSON:', e);
                    console.error('Response text:', responseText);
                    // If response is not JSON, treat as error
                    throw new Error(responseText || `Server returned ${response.status} ${response.statusText}`);
                }
                
                // Check if request was successful (200-299 status codes)
                if (response.ok) {
                    // If response explicitly says success=false, treat as error
                    if (data.success === false) {
                        console.error('API returned success=false:', data);
                        throw new Error(data.message || data.error || 'Failed to add menu item');
                    }
                    
                    // Success - show message and reset form
                    successMessage.textContent = data.message || 'Menu item added successfully!';
                    successMessage.style.display = 'block';
                    
                    // Reset form
                    document.getElementById('addMenuItemForm').reset();
                    document.getElementById('imagePreview').style.display = 'none';
                    
                    // Reload menu items
                    loadMenuItems();
                    
                    // Hide success message after 3 seconds
                    setTimeout(() => {
                        successMessage.style.display = 'none';
                    }, 3000);
                } else {
                    // Non-2xx status code - definitely an error
                    console.error('API returned error:', {
                        status: response.status,
                        statusText: response.statusText,
                        data: data
                    });
                    throw new Error(data.message || data.error || `Server returned ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error adding menu item:', error);
                errorMessage.textContent = error.message || 'An error occurred. Please try again.';
                errorMessage.style.display = 'block';
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        });
        
        // Load menu items from API
        async function loadMenuItems() {
            try {
                const response = await fetch('https://feastfetchfunctionappk224626-fjfadrgzcgfwcqev.centralindia-01.azurewebsites.net/api/menu');
                console.log('Response status:', response);
                if (!response.ok) {
                    throw new Error('Failed to load menu items');
                }
                
                const data = await response.json();
                const categories = data.categories || [];
                
                // Store menu items for edit function
                currentMenuItems = categories;
                
                // Build menu items map for order display
                menuItemsMap = {};
                categories.forEach(cat => {
                    if (cat.items) {
                        cat.items.forEach(item => {
                            menuItemsMap[item.id] = item;
                        });
                    }
                });
                
                // Count total items
                let totalItems = 0;
                categories.forEach(cat => {
                    totalItems += cat.items ? cat.items.length : 0;
                });
                document.getElementById('totalMenuItems').textContent = totalItems;
                
                // Render menu items
                const container = document.getElementById('menuItemsList');
                if (totalItems === 0) {
                    container.innerHTML = `
                        <div class="col-12 text-center py-5">
                            <i class="bi bi-card-list" style="font-size: 4rem; color: var(--gray-light);"></i>
                            <h4 class="mt-3 text-muted">No menu items yet</h4>
                            <p class="text-muted">Add your first menu item above</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = categories.map(category => {
                    if (!category.items || category.items.length === 0) return '';
                    
                    return category.items.map(item => `
                        <div class="col-md-6 col-lg-4">
                            <div class="card shadow-sm border-0 h-100">
                                <div class="card-img-top" style="height: 200px; background: ${item.imageUrl ? `url('${item.imageUrl}')` : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}; background-size: cover; background-position: center; position: relative;">
                                    ${!item.imageUrl ? '<i class="bi bi-image" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; color: white; opacity: 0.5;"></i>' : ''}
                                </div>
                                <div class="card-body">
                                    <h5 class="card-title">${item.name}</h5>
                                    <p class="card-text text-muted small">${item.description || ''}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-primary">${category.name}</span>
                                        <span class="fw-bold text-primary">$${parseFloat(item.price).toFixed(2)}</span>
                                    </div>
                                    <div class="mt-3 d-flex gap-2">
                                        <button class="btn btn-sm btn-outline-primary flex-fill" onclick="editMenuItem('${item.id}')">
                                            <i class="bi bi-pencil me-1"></i>Edit
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger flex-fill" onclick="deleteMenuItem('${item.id}')">
                                            <i class="bi bi-trash me-1"></i>Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }).filter(html => html).join('');
                
            } catch (error) {
                console.error('Error loading menu items:', error);
                document.getElementById('menuItemsList').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Failed to load menu items. Please try again.
                        </div>
                    </div>
                `;
            }
        }
        
        // Store current menu items for edit modal
        let currentMenuItems = [];
        // Store original item data for comparison during update
        let originalItemData = null;
        
        // Edit menu item - opens modal with item data
        async function editMenuItem(itemId) {
            console.log('Edit menu item:', itemId);
            
            // Find the item in the current menu items
            let item = null;
            let itemCategory = '';
            for (const category of currentMenuItems) {
                if (category.items) {
                    item = category.items.find(i => i.id === itemId);
                    if (item) {
                        // Try to get category from item first, then from parent category
                        itemCategory = item.category || category.name || '';
                        break;
                    }
                }
            }
            
            if (!item) {
                alert('Menu item not found. Please refresh the page.');
                return;
            }
            
            // Store original item data for comparison
            originalItemData = {
                id: item.id,
                name: item.name || '',
                description: item.description || '',
                category: item.category || itemCategory || '',
                price: item.price || '',
                available: item.available !== false ? 'true' : 'false'
            };
            
            // Populate edit form
            document.getElementById('editItemId').value = item.id;
            document.getElementById('editItemName').value = item.name || '';
            document.getElementById('editItemDescription').value = item.description || '';
            
            // Set category - try item.category first, then derive from parent category name
            const categorySelect = document.getElementById('editItemCategory');
            if (item.category) {
                categorySelect.value = item.category;
            } else if (itemCategory) {
                // Try to match category name to dropdown value
                const categoryMap = {
                    'appetizers': 'appetizers',
                    'main courses': 'main-courses',
                    'main-courses': 'main-courses',
                    'desserts': 'desserts',
                    'beverages': 'beverages',
                    'salads': 'salads',
                    'soups': 'soups'
                };
                const normalizedCategory = itemCategory.toLowerCase().trim();
                categorySelect.value = categoryMap[normalizedCategory] || '';
            }
            
            document.getElementById('editItemPrice').value = item.price || '';
            document.getElementById('editItemAvailable').value = item.available !== false ? 'true' : 'false';
            
            // Show current image if available
            if (item.imageUrl) {
                document.getElementById('editPreviewImg').src = item.imageUrl;
                document.getElementById('editImagePreview').style.display = 'block';
            } else {
                document.getElementById('editImagePreview').style.display = 'none';
            }
            
            // Hide messages
            document.getElementById('editErrorMessage').style.display = 'none';
            document.getElementById('editSuccessMessage').style.display = 'none';
            
            // Show the edit dialog
            showEditDialog(true);
        }
        
        // Handle edit form image preview
        document.getElementById('editItemImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('editPreviewImg').src = e.target.result;
                    document.getElementById('editImagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Handle update menu item
        
        document.getElementById('updateMenuItemButton').addEventListener('click', async function() {
            const form = document.getElementById('editMenuItemForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const itemId = document.getElementById('editItemId').value;
            const name = document.getElementById('editItemName').value.trim();
            const description = document.getElementById('editItemDescription').value.trim();
            const category = document.getElementById('editItemCategory').value;
            const price = parseFloat(document.getElementById('editItemPrice').value);
            const available = document.getElementById('editItemAvailable').value === 'true';
            const imageFile = document.getElementById('editItemImage').files[0];
            
            const errorMessage = document.getElementById('editErrorMessage');
            const successMessage = document.getElementById('editSuccessMessage');
            const submitButton = document.getElementById('updateMenuItemButton');
            const originalButtonText = submitButton.innerHTML;
            
            // Hide previous messages
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            
            // Disable button
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
            
            try {
                const apiUrl = `https://feastfetchfunctionappk224626-fjfadrgzcgfwcqev.centralindia-01.azurewebsites.net/api/admin/menu/${itemId}`;

                // Build request body with ONLY changed fields (API expects partial updates)
                const requestBody = {};
                
                // Only include fields that have actually changed
                if (originalItemData) {
                    if (name !== originalItemData.name) {
                        requestBody.name = name;
                    }
                    if (description !== originalItemData.description) {
                        requestBody.description = description;
                    }
                    if (category !== originalItemData.category) {
                        requestBody.category = category;
                    }
                    if (String(price) !== String(originalItemData.price)) {
                        requestBody.price = String(price);
                    }
                    if (String(available) !== String(originalItemData.available)) {
                        requestBody.available = String(available);
                    }
                } else {
                    // Fallback: if original data not available, send all fields
                    // (shouldn't happen, but safety fallback)
                    requestBody.name = name;
                    requestBody.description = description;
                    requestBody.category = category;
                    requestBody.price = String(price);
                    requestBody.available = String(available);
                }

                console.log('=== UPDATE MENU ITEM DEBUG ===');
                console.log('URL:', apiUrl);
                console.log('Item ID:', itemId);
                console.log('Original Data:', originalItemData);
                console.log('Request Body (only changed fields):', JSON.stringify(requestBody, null, 2));
                console.log('Admin Secret Key exists:', !!AdminUtils.getSecretKey());

                // Use AdminUtils which handles auth headers
                // API expects PATCH method, not PUT
                const response = await AdminUtils.adminApiCall(apiUrl, {
                    method: 'PATCH',
                    body: JSON.stringify(requestBody)
                });

                console.log('Response Status:', response.status, response.statusText);
                
                const responseText = await response.text();
                console.log('Response Body (raw):', responseText);
                console.log('=== END DEBUG ===');

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error('Failed to parse response as JSON:', e);
                    throw new Error(responseText || `Server returned ${response.status} ${response.statusText}`);
                }
                if (response.ok) {
                    if (data.success === false) {
                        throw new Error(data.message || 'Failed to update menu item');
                    }
                    
                    successMessage.textContent = data.message || 'Menu item updated successfully!';
                    successMessage.style.display = 'block';
                    
                    // Reload menu items
                    loadMenuItems();
                    
                    // Close dialog after 1.5 seconds
                    setTimeout(() => {
                        showEditDialog(false);
                        successMessage.style.display = 'none';
                    }, 1500);
                } else {
                    throw new Error(data.message || `Server returned ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error updating menu item:', error);
                errorMessage.textContent = error.message || 'An error occurred. Please try again.';
                errorMessage.style.display = 'block';
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        });
        
        // Delete menu item
        async function deleteMenuItem(itemId) {
            if (!confirm('Are you sure you want to delete this menu item? This action cannot be undone.')) {
                return;
            }
            
            try {
                console.log('Deleting menu item:', itemId);
                
                const apiUrl = `https://feastfetchfunctionappk224626-fjfadrgzcgfwcqev.centralindia-01.azurewebsites.net/api/admin/menu/${itemId}`;
                
                const response = await AdminUtils.adminApiCall(apiUrl, {
                    method: 'DELETE'
                });
                
                const responseText = await response.text();
                console.log('Delete response:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    // If response is not JSON, check if status is OK
                    if (response.ok) {
                        // Success even without JSON response
                        loadMenuItems();
                        alert('Menu item deleted successfully!');
                        return;
                    }
                    throw new Error(responseText || `Server returned ${response.status} ${response.statusText}`);
                }
                
                if (response.ok) {
                    if (data.success === false) {
                        throw new Error(data.message || 'Failed to delete menu item');
                    }
                    
                    // Reload menu items
                    loadMenuItems();
                    alert(data.message || 'Menu item deleted successfully!');
                } else {
                    throw new Error(data.message || `Server returned ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error deleting menu item:', error);
                alert('Failed to delete menu item: ' + (error.message || 'Please try again.'));
            }
        }
        
        // Load all orders from admin API
        async function loadOrders() {
            const container = document.getElementById('ordersList');
            
            try {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading orders...</p>
                    </div>
                `;
                
                const apiUrl = 'https://feastfetchfunctionappk224626-fjfadrgzcgfwcqev.centralindia-01.azurewebsites.net/api/admin/orders';
                
                const response = await AdminUtils.adminApiCall(apiUrl, {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to load orders: ${response.status} ${response.statusText}`);
                }
                
                const orders = await response.json();
                console.log('Loaded orders:', orders);
                
                // Update stats
                const totalOrders = orders.length || 0;
                const pendingOrders = orders.filter(o => o.status && o.status.toLowerCase() === 'pending').length || 0;
                
                document.getElementById('totalOrders').textContent = totalOrders;
                document.getElementById('pendingOrders').textContent = pendingOrders;
                
                // Render orders
                if (orders.length === 0) {
                    container.innerHTML = `
                        <div class="col-12 text-center py-5">
                            <i class="bi bi-inbox" style="font-size: 4rem; color: var(--gray-light);"></i>
                            <h4 class="mt-3 text-muted">No orders yet</h4>
                            <p class="text-muted">Orders will appear here when customers place them</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = orders.map(order => renderOrderCard(order)).join('');
                
            } catch (error) {
                console.error('Error loading orders:', error);
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Failed to load orders: ${error.message || 'Please try again.'}
                        </div>
                    </div>
                `;
            }
        }
        
        // Render order card
        function renderOrderCard(order) {
            const status = (order.status || 'pending').toLowerCase();
            const statusColor = status === 'completed' ? 'success' : 
                               status === 'cancelled' ? 'danger' : 
                               status === 'processing' ? 'info' : 'warning';
            
            // Render items
            let itemsHtml = '';
            let itemsTotal = 0;
            
            if (order.items && order.items.length > 0) {
                itemsHtml = order.items.map(item => {
                    const menuItem = menuItemsMap[item.id];
                    const itemName = menuItem ? menuItem.name : `Item ${item.id.substring(0, 8)}`;
                    const itemDescription = menuItem ? menuItem.description : '';
                    const itemImageUrl = menuItem ? menuItem.imageUrl : null;
                    const price = menuItem ? parseFloat(menuItem.price) || 0 : 0;
                    const qty = parseInt(item.quantity) || 1;
                    const itemTotal = price * qty;
                    itemsTotal += itemTotal;
                    
                    return `
                        <div class="d-flex align-items-center py-2 border-bottom">
                            ${itemImageUrl ? 
                                `<img src="${itemImageUrl}" alt="${itemName}" class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;">` : 
                                `<div class="bg-light rounded me-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;"><i class="bi bi-image text-muted"></i></div>`
                            }
                            <div class="flex-grow-1">
                                <strong>${itemName}</strong>
                                ${itemDescription ? `<p class="mb-0 text-muted small">${itemDescription}</p>` : ''}
                                <small class="text-muted">Qty: ${qty} Ã— $${price.toFixed(2)}</small>
                            </div>
                            <strong>$${itemTotal.toFixed(2)}</strong>
                        </div>
                    `;
                }).join('');
            }
            
            // Status options
            const statusOptions = ['pending', 'processing', 'completed', 'cancelled'];
            const currentStatus = order.status || 'pending';
            
            return `
                <div class="col-lg-6">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">Order #${order.id.substring(0, 8)}</h5>
                                <small>${new Date(order.createdAt).toLocaleString()}</small>
                            </div>
                            <span class="badge bg-${statusColor} fs-6 text-capitalize">${currentStatus}</span>
                        </div>
                        <div class="card-body">
                            <!-- Customer Info -->
                            <div class="mb-3">
                                <h6 class="text-muted"><i class="bi bi-person me-2"></i>Customer</h6>
                                <p class="mb-0"><strong>${order.customer?.name || 'N/A'}</strong></p>
                                <p class="mb-0 text-muted">${order.customer?.phone || 'N/A'}</p>
                            </div>
                            
                            <!-- Items -->
                            <div class="mb-3">
                                <h6 class="text-muted"><i class="bi bi-bag me-2"></i>Items</h6>
                                ${itemsHtml || '<p class="text-muted">No items</p>'}
                            </div>
                            
                            <!-- Total -->
                            <div class="d-flex justify-content-between align-items-center pt-2 border-top">
                                <strong>Total</strong>
                                <strong class="fs-5 text-primary">$${itemsTotal.toFixed(2)}</strong>
                            </div>
                            
                            ${order.notes ? `
                                <div class="mt-3 p-2 bg-light rounded">
                                    <small class="text-muted"><i class="bi bi-sticky me-1"></i>Notes: ${order.notes}</small>
                                </div>
                            ` : ''}
                            
                            <!-- Status Update -->
                            <div class="mt-3">
                                <label for="statusSelect_${order.id}" class="form-label fw-semibold small">Update Status</label>
                                <div class="input-group">
                                    <select class="form-select" id="statusSelect_${order.id}">
                                        ${statusOptions.map(opt => 
                                            `<option value="${opt}" ${opt.toLowerCase() === currentStatus.toLowerCase() ? 'selected' : ''}>${opt}</option>`
                                        ).join('')}
                                    </select>
                                    <button class="btn btn-outline-primary" onclick="updateOrderStatus('${order.id}')" id="updateBtn_${order.id}">
                                        <i class="bi bi-check-lg"></i> Update
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Update order status
        async function updateOrderStatus(orderId) {
            const statusSelect = document.getElementById(`statusSelect_${orderId}`);
            const newStatus = statusSelect.value;
            
            if (!newStatus || !newStatus.trim()) {
                alert('Please select a valid status');
                return;
            }
            
            const updateBtn = document.getElementById(`updateBtn_${orderId}`);
            const originalText = updateBtn.innerHTML;
            
            updateBtn.disabled = true;
            statusSelect.disabled = true;
            updateBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            
            try {
                const apiUrl = `https://feastfetchfunctionappk224626-fjfadrgzcgfwcqev.centralindia-01.azurewebsites.net/api/admin/order/${orderId}/status`;
                
                const response = await AdminUtils.adminApiCall(apiUrl, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        status: newStatus
                    })
                });
                
                const responseText = await response.text();
                let data;
                
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    if (response.ok) {
                        // Success even without JSON response
                        loadOrders();
                        return;
                    }
                    throw new Error(responseText || `Server returned ${response.status} ${response.statusText}`);
                }
                
                if (response.ok) {
                    if (data.success === false) {
                        throw new Error(data.message || 'Failed to update order status');
                    }
                    
                    // Reload orders to show updated status
                    loadOrders();
                } else {
                    throw new Error(data.message || `Server returned ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                alert('Failed to update order status: ' + (error.message || 'Please try again.'));
            } finally {
                updateBtn.disabled = false;
                statusSelect.disabled = false;
                updateBtn.innerHTML = originalText;
            }
        }
    </script>
}

