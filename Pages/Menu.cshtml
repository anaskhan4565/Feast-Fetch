@page
@model FeastFetch.Pages.MenuModel
@{
    ViewData["Title"] = "Menu";
}

<div class="page-header text-white text-center">
    <div class="container">
        <h1 class="display-3 fw-bold"><i class="bi bi-book me-3"></i>Menu</h1>
        <p class="lead">Browse our delicious selection</p>
    </div>
</div>

<div class="container py-5">
    <!-- Cart Button Header -->
    <div class="card shadow-lg border-0 mb-5">
        <div class="card-body p-4">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h2 class="mb-0 fw-bold">Menu Items</h2>
                </div>
                <div class="col-lg-4 text-end">
                    <a href="/Cart" class="btn btn-primary btn-lg px-4 py-3 position-relative">
                        <i class="bi bi-cart3 me-2"></i>View Cart
                        <span class="cart-badge" id="cartCount">0</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Menu Categories Sidebar -->
        <div class="col-lg-3 mb-4">
            <div class="card shadow-lg border-0 sticky-sidebar">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Categories</h5>
                </div>
                <div class="list-group list-group-flush" id="categorySidebar">
                    <!-- Categories will be loaded dynamically -->
                </div>
            </div>
        </div>

        <!-- Menu Items -->
        <div class="col-lg-9" id="menuItemsContainer">
            <!-- Loading indicator -->
            <div class="text-center py-5" id="loadingIndicator">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading menu items...</p>
            </div>
            <!-- Menu items will be loaded here dynamically -->
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        
        function updateCartCount() {
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartCount').textContent = count;
            if (count > 0) {
                document.getElementById('cartCount').style.display = 'flex';
            }
        }
        
        function addToCart(itemId, name, price) {
            const existingItem = cart.find(item => item.id === itemId);
            
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({ id: itemId, name, price, quantity: 1 });
            }
            
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
            
            // Show success animation
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Added!';
            btn.classList.add('btn-success');
            
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('btn-success');
            }, 1500);
        }
        
        function getCategoryIcon(categoryName) {
            const icons = {
                'Burgers': 'bi-egg-fried',
                'Cake': 'bi-cake2',
                'Pizza': 'bi-circle',
                'Shakes': 'bi-cup-straw',
                'Pasta': 'bi-menu-button',
                'Desserts': 'bi-cake2',
                'Beverages': 'bi-cup-straw',
                'Appetizers': 'bi-bowl',
                'Main Course': 'bi-egg-fried'
            };
            return icons[categoryName] || 'bi-tag';
        }
        
        function getGradientColor(index) {
            const gradients = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                'linear-gradient(135deg, #0ba360 0%, #3cba92 100%)',
                'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
            ];
            return gradients[index % gradients.length];
        }
        
        async function loadMenuItems() {
            try {
                console.log('Fetching menu items from API...');
                const response = await fetch('https://feastfetchfunctionappk224626-fjfadrgzcgfwcqev.centralindia-01.azurewebsites.net/api/menu');
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    throw new Error(`Failed to load menu items: ${response.status} ${response.statusText}`);
                }
                
                const responseText = await response.text();
                console.log('Response body (raw):', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('Response body (parsed):', data);
                } catch (parseError) {
                    console.error('Failed to parse JSON:', parseError);
                    console.error('Response text:', responseText);
                    throw new Error('Invalid JSON response from API');
                }
                
                const categories = data.categories || [];
                console.log('Categories loaded:', categories.length);
                
                // Hide loading indicator
                document.getElementById('loadingIndicator').style.display = 'none';
                
                // Render categories sidebar
                renderCategories(categories);
                
                // Render menu items
                renderMenuItems(categories);
                
                // Setup smooth scroll for category links
                setupCategoryLinks();
                
            } catch (error) {
                console.error('Error loading menu:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                document.getElementById('loadingIndicator').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Failed to load menu items. Please check the browser console for details.
                        <br><small>Error: ${error.message}</small>
                    </div>
                `;
            }
        }
        
        function renderCategories(categories) {
            const sidebar = document.getElementById('categorySidebar');
            sidebar.innerHTML = categories.map((category, index) => `
                <a href="#${category.name.toLowerCase().replace(/\s+/g, '-')}" 
                   class="list-group-item list-group-item-action menu-category-link ${index === 0 ? 'active' : ''}">
                    <i class="bi ${getCategoryIcon(category.name)} me-2"></i>${category.name}
                </a>
            `).join('');
        }
        
        function renderMenuItems(categories) {
            const container = document.getElementById('menuItemsContainer');
            container.innerHTML = categories.map(category => {
                const categoryId = category.name.toLowerCase().replace(/\s+/g, '-');
                const itemsHTML = category.items.map((item, index) => {
                    const imageStyle = item.imageUrl 
                        ? `background-image: url('${item.imageUrl}'); background-size: cover; background-position: center;`
                        : `background: ${getGradientColor(index)};`;
                    
                    return `
                        <div class="col-md-6">
                            <div class="menu-item-card">
                                <div class="menu-item-image" style="${imageStyle}">
                                    ${!item.imageUrl ? '<i class="bi bi-image restaurant-icon"></i>' : ''}
                                </div>
                                <div class="menu-item-content">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h5 class="menu-item-name">${item.name}</h5>
                                            <p class="menu-item-description">${item.description || ''}</p>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="menu-item-price">$${parseFloat(item.price).toFixed(2)}</span>
                                        <button class="btn btn-add-to-cart" onclick="addToCart('${item.id}', '${item.name.replace(/'/g, "\\'")}', ${item.price})">
                                            <i class="bi bi-plus-circle me-1"></i>Add
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div id="${categoryId}" class="menu-section mb-5">
                        <h3 class="section-title mb-4">
                            <i class="bi ${getCategoryIcon(category.name)} me-2"></i>${category.name}
                        </h3>
                        <div class="row g-4">
                            ${itemsHTML}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function setupCategoryLinks() {
            document.querySelectorAll('.menu-category-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    document.querySelectorAll('.menu-category-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    const targetId = this.getAttribute('href');
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        const yOffset = -100;
                        const y = targetElement.getBoundingClientRect().top + window.pageYOffset + yOffset;
                        window.scrollTo({ top: y, behavior: 'smooth' });
                    }
                });
            });
        }
        
        // Load menu on page load
        updateCartCount();
        loadMenuItems();
    </script>
}

