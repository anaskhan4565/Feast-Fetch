@page
@model FeastFetch.Pages.RestaurantOwner.MenuModel
@{
    ViewData["Title"] = "Manage Menu";
}

<div class="page-header text-white text-center">
    <div class="container">
        <h1 class="display-3 fw-bold"><i class="bi bi-card-list me-3"></i>Manage Menu</h1>
        <p class="lead">Add, edit, and manage your menu items</p>
    </div>
</div>

<div class="container py-5">
    <!-- Add New Item Button -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">Menu Items</h2>
        <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addItemModal">
            <i class="bi bi-plus-circle me-2"></i>Add New Item
        </button>
    </div>

    <!-- Menu Items Grid -->
    <div class="row g-4" id="menuItemsGrid">
        <!-- Items will be loaded here -->
    </div>
</div>

<!-- Add/Edit Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addItemModalLabel">
                    <i class="bi bi-plus-circle me-2"></i>Add New Menu Item
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="menuItemForm">
                    <input type="hidden" id="itemId">
                    
                    <div class="mb-4">
                        <label for="itemName" class="form-label fw-semibold">
                            <i class="bi bi-tag me-2"></i>Item Name *
                        </label>
                        <input type="text" class="form-control form-control-lg" id="itemName" placeholder="e.g., Margherita Pizza" required>
                    </div>

                    <div class="mb-4">
                        <label for="itemDescription" class="form-label fw-semibold">
                            <i class="bi bi-text-paragraph me-2"></i>Description *
                        </label>
                        <textarea class="form-control" id="itemDescription" rows="3" placeholder="Describe your menu item" required></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label for="itemPrice" class="form-label fw-semibold">
                                <i class="bi bi-currency-dollar me-2"></i>Price *
                            </label>
                            <input type="number" class="form-control form-control-lg" id="itemPrice" step="0.01" min="0" placeholder="0.00" required>
                        </div>

                        <div class="col-md-6 mb-4">
                            <label for="itemCategory" class="form-label fw-semibold">
                                <i class="bi bi-list-ul me-2"></i>Category *
                            </label>
                            <select class="form-select form-select-lg" id="itemCategory" required>
                                <option value="">Select category</option>
                                <option value="Appetizers">Appetizers</option>
                                <option value="Main Course">Main Course</option>
                                <option value="Pasta">Pasta</option>
                                <option value="Pizza">Pizza</option>
                                <option value="Desserts">Desserts</option>
                                <option value="Beverages">Beverages</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="itemImage" class="form-label fw-semibold">
                            <i class="bi bi-image me-2"></i>Item Image
                        </label>
                        <input type="file" class="form-control form-control-lg" id="itemImage" accept="image/*">
                        <small class="text-muted">Upload an image for this menu item (optional)</small>
                        <div id="imagePreview" class="mt-3" style="display: none;">
                            <img id="previewImg" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="itemAvailable" checked>
                                <label class="form-check-label" for="itemAvailable">
                                    Item Available
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="itemFeatured">
                                <label class="form-check-label" for="itemFeatured">
                                    Featured Item
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-danger" id="formError" style="display: none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveMenuItem">
                    <i class="bi bi-check-circle me-2"></i>Save Item
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let editingItemId = null;
        
        // Check authentication
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        if (!currentUser || currentUser.userType !== 'RestaurantOwner') {
            window.location.href = '/Login';
        }
        
        // Load menu items
        function loadMenuItems() {
            const restaurant = currentUser.restaurant || {};
            const menuItems = restaurant.menuItems || [];
            
            const grid = document.getElementById('menuItemsGrid');
            
            if (menuItems.length === 0) {
                grid.innerHTML = `
                    <div class="col-12">
                        <div class="card shadow-lg border-0 text-center py-5">
                            <div class="card-body">
                                <i class="bi bi-card-list" style="font-size: 4rem; color: var(--gray-light);"></i>
                                <h4 class="mt-3 text-muted">No menu items yet</h4>
                                <p class="text-muted">Click "Add New Item" to get started</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = menuItems.map(item => `
                <div class="col-lg-4 col-md-6">
                    <div class="card shadow-lg border-0 menu-item-card">
                        <div class="menu-item-image" style="background: ${item.imageUrl ? `url('${item.imageUrl}')` : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}; background-size: cover; background-position: center;">
                            ${!item.imageUrl ? '<i class="bi bi-image restaurant-icon"></i>' : ''}
                            <div class="position-absolute top-0 end-0 m-2">
                                ${item.isFeatured ? '<span class="badge bg-warning text-dark"><i class="bi bi-star-fill"></i> Featured</span>' : ''}
                            </div>
                        </div>
                        <div class="card-body">
                            <h5 class="fw-bold mb-2">${item.name}</h5>
                            <p class="text-muted small mb-2">${item.description}</p>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="badge bg-primary">${item.category}</span>
                                <span class="fw-bold text-primary">$${parseFloat(item.price).toFixed(2)}</span>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary flex-fill" onclick="editItem(${item.id})">
                                    <i class="bi bi-pencil me-1"></i>Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger flex-fill" onclick="deleteItem(${item.id})">
                                    <i class="bi bi-trash me-1"></i>Delete
                                </button>
                            </div>
                            <div class="mt-2">
                                <span class="badge bg-${item.isAvailable ? 'success' : 'danger'}">
                                    ${item.isAvailable ? 'Available' : 'Unavailable'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Image preview
        document.getElementById('itemImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Save menu item
        document.getElementById('saveMenuItem').addEventListener('click', function() {
            const form = document.getElementById('menuItemForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const itemData = {
                id: editingItemId || Date.now(),
                name: document.getElementById('itemName').value,
                description: document.getElementById('itemDescription').value,
                price: parseFloat(document.getElementById('itemPrice').value),
                category: document.getElementById('itemCategory').value,
                isAvailable: document.getElementById('itemAvailable').checked,
                isFeatured: document.getElementById('itemFeatured').checked,
                imageUrl: document.getElementById('previewImg').src || null
            };
            
            // Get restaurant data
            if (!currentUser.restaurant) {
                currentUser.restaurant = { menuItems: [] };
            }
            if (!currentUser.restaurant.menuItems) {
                currentUser.restaurant.menuItems = [];
            }
            
            if (editingItemId) {
                // Update existing item
                const index = currentUser.restaurant.menuItems.findIndex(item => item.id === editingItemId);
                if (index !== -1) {
                    currentUser.restaurant.menuItems[index] = itemData;
                }
            } else {
                // Add new item
                currentUser.restaurant.menuItems.push(itemData);
            }
            
            // Save to localStorage
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                localStorage.setItem('users', JSON.stringify(users));
            }
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Close modal and reload
            const modal = bootstrap.Modal.getInstance(document.getElementById('addItemModal'));
            modal.hide();
            resetForm();
            loadMenuItems();
        });
        
        // Edit item
        function editItem(itemId) {
            const item = currentUser.restaurant.menuItems.find(i => i.id === itemId);
            if (!item) return;
            
            editingItemId = itemId;
            document.getElementById('itemId').value = itemId;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemDescription').value = item.description;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemAvailable').checked = item.isAvailable;
            document.getElementById('itemFeatured').checked = item.isFeatured;
            
            if (item.imageUrl) {
                document.getElementById('previewImg').src = item.imageUrl;
                document.getElementById('imagePreview').style.display = 'block';
            }
            
            document.getElementById('addItemModalLabel').innerHTML = '<i class="bi bi-pencil me-2"></i>Edit Menu Item';
            
            const modal = new bootstrap.Modal(document.getElementById('addItemModal'));
            modal.show();
        }
        
        // Delete item
        function deleteItem(itemId) {
            if (!confirm('Are you sure you want to delete this menu item?')) return;
            
            currentUser.restaurant.menuItems = currentUser.restaurant.menuItems.filter(item => item.id !== itemId);
            
            // Save to localStorage
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                localStorage.setItem('users', JSON.stringify(users));
            }
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            loadMenuItems();
        }
        
        // Reset form
        function resetForm() {
            editingItemId = null;
            document.getElementById('menuItemForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('addItemModalLabel').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Add New Menu Item';
        }
        
        // Reset form when modal is closed
        document.getElementById('addItemModal').addEventListener('hidden.bs.modal', function() {
            resetForm();
        });
        
        // Load on page load
        loadMenuItems();
    </script>
}

