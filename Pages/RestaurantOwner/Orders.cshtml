@page
@model FeastFetch.Pages.RestaurantOwner.OrdersModel
@{
    ViewData["Title"] = "Restaurant Orders";
}

<div class="page-header text-white text-center">
    <div class="container">
        <h1 class="display-3 fw-bold"><i class="bi bi-box-seam me-3"></i>Orders</h1>
        <p class="lead">Manage and track your restaurant orders</p>
    </div>
</div>

<div class="container py-5">
    <!-- Filter Tabs -->
    <div class="card shadow-lg border-0 mb-4">
        <div class="card-body">
            <ul class="nav nav-pills" id="orderTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab">
                        All Orders
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                        Pending
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="preparing-tab" data-bs-toggle="tab" data-bs-target="#preparing" type="button" role="tab">
                        Preparing
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="ready-tab" data-bs-toggle="tab" data-bs-target="#ready" type="button" role="tab">
                        Ready
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- Orders Content -->
    <div class="tab-content" id="orderTabsContent">
        <div class="tab-pane fade show active" id="all" role="tabpanel">
            <div id="allOrders" class="orders-container"></div>
        </div>
        <div class="tab-pane fade" id="pending" role="tabpanel">
            <div id="pendingOrders" class="orders-container"></div>
        </div>
        <div class="tab-pane fade" id="preparing" role="tabpanel">
            <div id="preparingOrders" class="orders-container"></div>
        </div>
        <div class="tab-pane fade" id="ready" role="tabpanel">
            <div id="readyOrders" class="orders-container"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Check authentication
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        if (!currentUser || currentUser.userType !== 'RestaurantOwner') {
            window.location.href = '/Login';
        }
        
        // Load orders
        function loadOrders() {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const restaurantOrders = orders.filter(o => o.restaurantId === currentUser.id);
            
            displayOrders(restaurantOrders, 'allOrders');
            displayOrders(restaurantOrders.filter(o => o.status === 'Pending'), 'pendingOrders');
            displayOrders(restaurantOrders.filter(o => o.status === 'Preparing'), 'preparingOrders');
            displayOrders(restaurantOrders.filter(o => o.status === 'Ready'), 'readyOrders');
        }
        
        function displayOrders(orders, containerId) {
            const container = document.getElementById(containerId);
            
            if (orders.length === 0) {
                container.innerHTML = '<p class="text-muted text-center py-5">No orders found</p>';
                return;
            }
            
            container.innerHTML = orders.map(order => `
                <div class="card shadow-lg border-0 mb-4 order-card">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h4 class="fw-bold mb-1">Order #${order.id}</h4>
                                <p class="text-muted mb-0 small">${new Date(order.date).toLocaleString()}</p>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-${getStatusColor(order.status)} mb-2" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                                    ${order.status}
                                </span>
                                <h5 class="mb-0 fw-bold text-primary">$${parseFloat(order.total || 0).toFixed(2)}</h5>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6 class="fw-bold mb-2">Items:</h6>
                            <ul class="list-unstyled">
                                ${order.items.map(item => `
                                    <li class="d-flex justify-content-between py-2 border-bottom">
                                        <span>${item.name} x ${item.quantity}</span>
                                        <span class="fw-bold">$${(parseFloat(item.price) * item.quantity).toFixed(2)}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        
                        <div class="d-flex gap-2 flex-wrap">
                            ${order.status === 'Pending' ? `
                                <button class="btn btn-primary" onclick="updateOrderStatus(${order.id}, 'Preparing')">
                                    <i class="bi bi-check-circle me-1"></i>Start Preparing
                                </button>
                            ` : ''}
                            ${order.status === 'Preparing' ? `
                                <button class="btn btn-success" onclick="updateOrderStatus(${order.id}, 'Ready')">
                                    <i class="bi bi-check-circle me-1"></i>Mark as Ready
                                </button>
                            ` : ''}
                            ${order.status === 'Ready' ? `
                                <button class="btn btn-info" onclick="updateOrderStatus(${order.id}, 'Delivered')">
                                    <i class="bi bi-truck me-1"></i>Mark as Delivered
                                </button>
                            ` : ''}
                            ${order.status === 'Pending' ? `
                                <button class="btn btn-danger" onclick="updateOrderStatus(${order.id}, 'Cancelled')">
                                    <i class="bi bi-x-circle me-1"></i>Cancel Order
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function getStatusColor(status) {
            const colors = {
                'Pending': 'warning',
                'Preparing': 'info',
                'Ready': 'success',
                'Delivered': 'success',
                'Cancelled': 'danger'
            };
            return colors[status] || 'secondary';
        }
        
        function updateOrderStatus(orderId, newStatus) {
            if (!confirm(`Are you sure you want to update this order to "${newStatus}"?`)) return;
            
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const orderIndex = orders.findIndex(o => o.id === orderId);
            
            if (orderIndex !== -1) {
                orders[orderIndex].status = newStatus;
                localStorage.setItem('orders', JSON.stringify(orders));
                loadOrders();
            }
        }
        
        loadOrders();
    </script>
}

